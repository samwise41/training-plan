<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athlete Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js to convert Markdown to HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- GitHub Markdown CSS for professional formatting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-dark.min.css">
    
    <style>
        body {
            background-color: #0f172a; /* Original Slate 900 */
            color: #f8fafc;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-x: hidden;
        }

        /* Custom overrides for the markdown container */
        .markdown-body {
            background-color: transparent !important;
            font-family: inherit;
            color: #cbd5e1 !important;
            line-height: 1.6;
        }
        .markdown-body table {
            display: table;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .markdown-body table th {
            background-color: #1e293b !important;
            color: #3b82f6 !important;
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 12px !important;
        }
        .markdown-body table td {
            padding: 12px !important;
            border-top: 1px solid #334155 !important;
        }
        .markdown-body table tr {
            background-color: #0f172a !important;
        }
        .markdown-body h1, .markdown-body h2 {
            border-bottom: 1px solid #334155 !important;
            color: #f8fafc !important;
            margin-top: 2rem !important;
        }
        .markdown-body a {
            color: #3b82f6 !important;
        }
        
        /* Nav highlighting */
        .nav-link.active {
            color: #3b82f6;
            background-color: #1e293b;
            border-right: 4px solid #3b82f6;
        }

        /* Loading animation */
        .loader {
            border-top-color: #3b82f6;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar transitions */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 60;
        }
        .sidebar-open {
            transform: translateX(0);
        }
        .sidebar-closed {
            transform: translateX(-100%);
        }

        @media (min-width: 1024px) {
            #sidebar {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 260px;
            }
        }

        /* Zone List Styling */
        #zone-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 768px) {
            #zone-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .zone-card {
            background-color: rgba(30, 41, 59, 0.3);
            border: 1px solid #1e293b;
            border-radius: 12px;
            padding: 1.5rem;
            height: 100%;
        }
        .zone-card-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: #f8fafc;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #334155;
            padding-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .zone-row {
            margin-bottom: 0.75rem;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
            border-left: 6px solid #64748b; /* Default Grey */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            transition: transform 0.2s;
        }
        @media (min-width: 400px) {
            .zone-row {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        .zone-row:hover {
            transform: translateX(4px);
        }
        /* Zone Colors */
        .zone-z1 { border-left-color: #94a3b8 !important; } /* Grey */
        .zone-z2 { border-left-color: #22c55e !important; } /* Green */
        .zone-z3 { border-left-color: #eab308 !important; } /* Yellow */
        .zone-z4 { border-left-color: #f97316 !important; } /* Orange */
        .zone-z5 { border-left-color: #ef4444 !important; } /* Red */

        .zone-label {
            font-weight: 700;
            color: #e2e8f0;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        @media (min-width: 400px) {
            .zone-label { margin-bottom: 0; }
        }
        .zone-range {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            color: #94a3b8;
            font-size: 0.85rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- MOBILE OVERLAY -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 hidden z-50"></div>

    <!-- LEFT SIDEBAR -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-[260px] bg-slate-900 border-r border-slate-800 sidebar-closed lg:sidebar-open flex flex-col">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center">
            <span class="font-bold tracking-widest text-slate-400 text-xs uppercase">Navigation</span>
            <button onclick="toggleSidebar()" class="lg:hidden text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <nav class="flex-1 py-4 overflow-y-auto">
            <button onclick="showSchedule(); toggleSidebarMobile();" id="nav-schedule" class="nav-link w-full text-left px-6 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Weekly Schedule
            </button>
            <button onclick="showPhases(); toggleSidebarMobile();" id="nav-phases" class="nav-link w-full text-left px-6 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                Phases
            </button>
            <button onclick="showZones(); toggleSidebarMobile();" id="nav-zones" class="nav-link w-full text-left px-6 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                Zones
            </button>
            <button onclick="showFullPlan(); toggleSidebarMobile();" id="nav-full" class="nav-link w-full text-left px-6 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Full Plan
            </button>
        </nav>

        <div class="p-6 border-t border-slate-800">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Live Sync</span>
            </div>
        </div>
    </aside>

    <!-- TOP MOBILE BAR -->
    <header class="lg:hidden bg-slate-900 border-b border-slate-800 sticky top-0 z-40 h-16 flex items-center px-4">
        <button onclick="toggleSidebar()" class="p-2 text-slate-400 hover:text-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <h1 class="ml-4 text-lg font-bold text-white tracking-tight" id="mobile-header-title">Weekly Schedule</h1>
    </header>

    <div class="main-content">
        <!-- HEADER SECTION -->
        <header class="max-w-5xl mx-auto px-4 pt-12 pb-8 text-center sm:text-left hidden lg:block">
            <h1 class="text-4xl font-extrabold text-white sm:text-5xl tracking-tight" id="header-title">
                Weekly Schedule
            </h1>
            <p class="mt-3 text-slate-400 text-lg" id="header-subtitle">
                Synchronized with <span class="font-mono text-blue-400">endurance_plan.md</span>
            </p>
        </header>

        <!-- MAIN CONTENT -->
        <main class="max-w-5xl mx-auto px-4 pb-20">
            
            <!-- DASHBOARD STATS -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-10">
                <!-- Box 1: Current Phase -->
                <div class="bg-slate-800/50 border border-slate-700 p-4 rounded-lg">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Current Phase</p>
                    <p class="text-lg font-semibold text-blue-400" id="stat-phase">--</p>
                </div>
                <!-- Box 2: Current Week -->
                <div class="bg-slate-800/50 border border-slate-700 p-4 rounded-lg">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Current Week</p>
                    <p class="text-lg font-semibold text-slate-300" id="stat-week">--</p>
                </div>
                <!-- Box 3: Next Event -->
                <div class="bg-slate-800/50 border border-slate-700 p-4 rounded-lg">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Next Event</p>
                    <div id="stat-event">
                        <p class="text-lg font-semibold text-emerald-400 leading-tight" id="stat-event-name">--</p>
                        <p class="text-sm font-normal text-slate-400 mt-1" id="stat-event-countdown">--</p>
                    </div>
                </div>
            </div>

            <!-- LOADER -->
            <div id="loader-container" class="flex flex-col items-center justify-center py-20">
                <div class="loader ease-linear rounded-full border-2 border-t-2 border-slate-700 h-10 w-10 mb-4"></div>
                <p class="text-slate-500 text-sm font-medium">Parsing Athlete Data...</p>
            </div>

            <!-- CONTENT AREA -->
            <div id="markdown-content" class="markdown-body hidden transition-opacity duration-500 opacity-0">
                <!-- Rendered Content -->
            </div>

            <!-- ERROR AREA -->
            <div id="error-container" class="hidden bg-red-900/10 border border-red-500/50 p-6 rounded-lg text-center">
                <p class="text-red-400 font-bold mb-2">Sync Error</p>
                <p class="text-red-300 text-sm mb-4" id="error-msg">File not found.</p>
                <button onclick="window.location.reload()" class="text-blue-400 text-sm font-bold hover:underline">Retry Connection</button>
            </div>

        </main>
    </div>

    <script>
        const SOURCE_FILE = "endurance_plan.md";
        let cachedMarkdown = ""; 

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('sidebar-closed')) {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('sidebar-closed');
                sidebar.classList.remove('sidebar-open');
                overlay.classList.add('hidden');
            }
        }

        function toggleSidebarMobile() {
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        async function fetchFile() {
            if (cachedMarkdown) return cachedMarkdown;
            const cacheBuster = `t=${new Date().getTime()}`;
            const response = await fetch(`./${SOURCE_FILE}?${cacheBuster}`);
            if (!response.ok) throw new Error(`Could not load ${SOURCE_FILE}`);
            cachedMarkdown = await response.text();
            
            updateHeaderStats(cachedMarkdown);
            return cachedMarkdown;
        }

        function updateHeaderStats(md) {
            const statusMatch = md.match(/\*\*Status:\*\*\s*(Phase[^-]*)\s*-\s*(Week.*)/i);
            let phase = "--", week = "--";
            if (statusMatch) {
                phase = statusMatch[1].trim();
                week = statusMatch[2].trim();
            } else {
                const pMatch = md.match(/\*\*Phase:\*\*\s*(.*)/);
                const wMatch = md.match(/\*\*Week:\*\*\s*(.*)/);
                if (pMatch) phase = pMatch[1].trim();
                if (wMatch) week = wMatch[1].trim();
            }
            document.getElementById('stat-phase').innerText = phase;
            document.getElementById('stat-week').innerText = week;

            const eventSection = extractSection(md, "Event Schedule");
            const nameElement = document.getElementById('stat-event-name');
            const countdownElement = document.getElementById('stat-event-countdown');

            if (eventSection) {
                const lines = eventSection.split('\n').filter(l => l.includes('|') && !l.toLowerCase().includes('date') && !l.includes('---'));
                if (lines.length > 0) {
                    const parts = lines[0].split('|').map(p => p.trim()).filter(p => p.length > 0);
                    if (parts.length >= 2) {
                        const eventDate = new Date(parts[0]);
                        const eventName = parts[1];
                        nameElement.innerText = eventName;
                        if (!isNaN(eventDate)) {
                            const today = new Date(); today.setHours(0,0,0,0);
                            const diffInDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                            if (diffInDays < 0) countdownElement.innerText = "Completed";
                            else if (diffInDays === 0) countdownElement.innerText = "Event Today";
                            else {
                                const w = Math.floor(diffInDays / 7);
                                const d = diffInDays % 7;
                                let str = "";
                                if (w > 0) str += `${w} week${w > 1 ? 's' : ''}`;
                                if (w > 0 && d > 0) str += " and ";
                                if (d > 0 || w === 0) str += `${d} day${d !== 1 ? 's' : ''}`;
                                countdownElement.innerText = `${str} until event`;
                            }
                        } else countdownElement.innerText = "Date TBD";
                    } else { nameElement.innerText = "None Scheduled"; countdownElement.innerText = "--"; }
                } else { nameElement.innerText = "None Scheduled"; countdownElement.innerText = "--"; }
            } else { nameElement.innerText = "None Scheduled"; countdownElement.innerText = "--"; }
        }

        async function showSchedule() {
            updateUI('Weekly Schedule', 'nav-schedule', true);
            try {
                const md = await fetchFile();
                const section = extractSection(md, "Weekly Schedule");
                render(section || "*Schedule section not found.*");
            } catch (err) { handleError(err); }
        }

        async function showPhases() {
            updateUI('Periodization Phases', 'nav-phases', true);
            try {
                const md = await fetchFile();
                const section = extractSection(md, "Periodization"); 
                render(section || "*Phases section not found.*");
            } catch (err) { handleError(err); }
        }

        async function showZones() {
            updateUI('Training Zones', 'nav-zones', false);
            try {
                const md = await fetchFile();
                const section = extractSection(md, "Training Parameters");
                
                if (!section) {
                    render("*Training Parameters section not found.*");
                    return;
                }

                // Split into lines for analysis
                const lines = section.split('\n');
                let html = '<div id="zone-grid">';
                let currentCategory = '';
                let categoryZones = [];

                function flushCategory() {
                    if (currentCategory && categoryZones.length > 0) {
                        html += `
                            <div class="zone-card">
                                <div class="zone-card-title">${currentCategory}</div>
                                ${categoryZones.join('')}
                            </div>
                        `;
                        categoryZones = [];
                    }
                }

                lines.forEach(line => {
                    const trimmed = line.trim();
                    
                    // Detect sub-headers (### Category Name)
                    if (trimmed.startsWith('###')) {
                        flushCategory();
                        currentCategory = trimmed.replace(/^###\s*/, '').trim();
                    } 
                    // Detect zone entries (Bullet points with "Zone X ... : ...")
                    else if (trimmed.includes('Zone') && trimmed.includes(':')) {
                        // Clean up markdown syntax (*, -)
                        const cleanLine = trimmed.replace(/^[\s\*\-\+]+/, '').replace(/\*\*/g, '').trim();
                        const sepIndex = cleanLine.indexOf(':');
                        
                        if (sepIndex !== -1) {
                            const label = cleanLine.substring(0, sepIndex).trim();
                            const range = cleanLine.substring(sepIndex + 1).trim();
                            
                            // Color Logic
                            let colorClass = 'zone-z1'; // Default Grey
                            if (label.toLowerCase().includes('zone 2')) colorClass = 'zone-z2'; // Green
                            else if (label.toLowerCase().includes('zone 3')) colorClass = 'zone-z3'; // Yellow
                            else if (label.toLowerCase().includes('zone 4')) colorClass = 'zone-z4'; // Orange
                            else if (label.toLowerCase().includes('zone 5')) colorClass = 'zone-z5'; // Red

                            categoryZones.push(`
                                <div class="zone-row ${colorClass}">
                                    <span class="zone-label">${label}</span>
                                    <span class="zone-range">${range}</span>
                                </div>
                            `);
                        }
                    }
                });

                flushCategory(); // Capture the last category
                html += '</div>';

                const contentDiv = document.getElementById('markdown-content');
                // Check if we actually found structured zones
                if (html.includes('zone-row')) {
                    contentDiv.innerHTML = html;
                } else {
                    // Fallback if parsing fails (no ### headers or Zone lines found)
                    contentDiv.classList.add('markdown-body');
                    contentDiv.innerHTML = marked.parse(section);
                }
                finalizeRendering();

            } catch (err) { handleError(err); }
        }

        async function showFullPlan() {
            updateUI('Endurance Master Plan', 'nav-full', true);
            try {
                const md = await fetchFile();
                const planOnly = excludeSection(md, "Appendix C");
                render(planOnly);
            } catch (err) { handleError(err); }
        }

        async function showAppendix() {
            try {
                const md = await fetchFile();
                const section = extractSection(md, "Appendix C");
                if (!section) {
                    updateUI('Summary', 'nav-appendix', true);
                    render("*Appendix C not found.*");
                    return;
                }
                const htmlMatch = section.match(/```html([\s\S]*?)```/);
                if (htmlMatch) {
                    updateUI('Summary', 'nav-appendix', false);
                    renderRawHTML(htmlMatch[1].trim());
                } else if (section.includes('<svg') || section.includes('<div')) {
                    updateUI('Summary', 'nav-appendix', false);
                    renderRawHTML(section);
                } else {
                    updateUI('Summary', 'nav-appendix', true);
                    render(section);
                }
            } catch (err) { handleError(err); }
        }

        function extractSection(md, title) {
            const lines = md.split('\n');
            let capturing = false;
            let section = [];
            for (let line of lines) {
                const trimmed = line.trim();
                // Check if this is a main Level 2 header (## but not ###)
                const isMainHeader = trimmed.startsWith('##') && !trimmed.startsWith('###');
                
                if (isMainHeader && trimmed.toLowerCase().includes(title.toLowerCase())) {
                    capturing = true;
                    section.push(line);
                    continue;
                }
                
                // Stop if we hit the next main header
                if (capturing && isMainHeader) break;
                
                if (capturing) {
                    const cleanLine = line.replace(/Error loading plan\. Please ensure the repository is Public and the filename is correct\./g, '');
                    section.push(cleanLine);
                }
            }
            return section.join('\n').trim();
        }

        function excludeSection(md, title) {
            const lines = md.split('\n');
            let result = [];
            let skipping = false;
            for (let line of lines) {
                const trimmed = line.trim();
                const isMainHeader = trimmed.startsWith('##') && !trimmed.startsWith('###');
                
                if (isMainHeader && trimmed.toLowerCase().includes(title.toLowerCase())) {
                    skipping = true;
                    continue;
                }
                
                if (skipping && isMainHeader) skipping = false;
                
                if (!skipping) {
                    const cleanLine = line.replace(/Error loading plan\. Please ensure the repository is Public and the filename is correct\./g, '');
                    result.push(cleanLine);
                }
            }
            return result.join('\n').trim();
        }

        function updateUI(title, navId, isMarkdown) {
            document.getElementById('header-title').innerText = title;
            document.getElementById('mobile-header-title').innerText = title;
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(navId);
            if (activeNav) activeNav.classList.add('active');
            
            const contentDiv = document.getElementById('markdown-content');
            contentDiv.classList.add('hidden', 'opacity-0');
            
            if (isMarkdown) {
                contentDiv.classList.add('markdown-body');
            } else {
                contentDiv.classList.remove('markdown-body');
            }

            document.getElementById('loader-container').classList.remove('hidden');
            document.getElementById('error-container').classList.add('hidden');
        }

        function render(md) {
            marked.setOptions({ gfm: true, breaks: true });
            const contentDiv = document.getElementById('markdown-content');
            contentDiv.innerHTML = marked.parse(md);
            finalizeRendering();
        }

        function renderRawHTML(html) {
            const contentDiv = document.getElementById('markdown-content');
            const iframe = document.createElement('iframe');
            iframe.id = 'infographic-container';
            contentDiv.innerHTML = '';
            contentDiv.appendChild(iframe);
            const iframeDoc = `<html><head><style>body { margin: 0; padding: 0; background: transparent; color: white; font-family: sans-serif; } * { box-sizing: border-box; }</style></head><body>${html}</body></html>`;
            iframe.srcdoc = iframeDoc;
            iframe.onload = function() {
                setTimeout(() => {
                    const b = iframe.contentWindow.document.body;
                    const h = iframe.contentWindow.document.documentElement;
                    const height = Math.max(b.scrollHeight, b.offsetHeight, h.clientHeight, h.scrollHeight, h.offsetHeight);
                    iframe.style.height = height + 'px';
                }, 100);
            };
            finalizeRendering();
        }

        function finalizeRendering() {
            document.getElementById('loader-container').classList.add('hidden');
            const contentDiv = document.getElementById('markdown-content');
            contentDiv.classList.remove('hidden');
            setTimeout(() => contentDiv.classList.remove('opacity-0'), 50);
        }

        function handleError(err) {
            console.error(err);
            document.getElementById('loader-container').classList.add('hidden');
            document.getElementById('error-container').classList.remove('hidden');
            document.getElementById('error-msg').innerText = err.message;
        }

        window.onload = showSchedule; 
    </script>
</body>
</html>
