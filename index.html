<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athlete Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-dark.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.3);
            --border-slate: #1e293b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
        }

        .nav-link.active {
            color: #3b82f6;
            background-color: #1e293b;
            border-right: 4px solid #3b82f6;
        }

        #sidebar { transition: transform 0.3s ease-in-out; z-index: 60; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }

        @media (min-width: 1024px) {
            #sidebar { transform: translateX(0); }
            .main-content { margin-left: 260px; }
        }

        .markdown-body {
            background-color: transparent !important;
            color: #cbd5e1 !important;
        }
        .markdown-body table {
            display: table !important;
            width: 100% !important; 
            border-collapse: separate !important;
            border-spacing: 0 !important;
            border: 1px solid #334155 !important; 
            border-radius: 8px !important; 
            overflow: hidden !important;
            margin-bottom: 2rem !important;
        }
        .markdown-body table th { 
            background-color: #1e293b !important; 
            color: #3b82f6 !important; 
            padding: 12px !important; 
            text-align: left !important;
            text-transform: uppercase !important;
            font-size: 0.75rem !important;
            letter-spacing: 0.05em !important;
        }
        .markdown-body table td {
            padding: 12px !important;
            border-top: 1px solid #334155 !important;
        }
        .markdown-body table tr { background-color: var(--bg-dark) !important; }

        .gauge-wrapper { width: 100%; max-width: 400px; margin: 0 auto 3rem; text-align: center; }
        .gauge-needle { transition: transform 2s cubic-bezier(0.17, 0.67, 0.38, 1); transform-origin: 150px 150px; }

        #zone-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 768px) { #zone-grid { grid-template-columns: 1fr 1fr; } }
        
        .zone-card { background-color: var(--bg-card); border: 1px solid var(--border-slate); border-radius: 12px; padding: 1.5rem; }
        .zone-card-title {
            font-size: 1.1rem; font-weight: 800; color: var(--text-main);
            margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-slate);
            padding-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .zone-row {
            margin-bottom: 0.75rem; padding: 1rem; background: var(--bg-dark); border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #64748b;
        }
        .z-1 { border-left-color: #94a3b8; }
        .z-2 { border-left-color: #22c55e; }
        .z-3 { border-left-color: #eab308; }
        .z-4 { border-left-color: #f97316; }
        .z-5 { border-left-color: #ef4444; }

        /* Gear Selection Styles */
        .gear-select {
            background-color: #1e293b;
            color: #f8fafc;
            border: 1px solid #334155;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="sidebar-overlay" onclick="App.toggleSidebar()" class="fixed inset-0 bg-black/50 hidden z-50"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-[260px] bg-slate-900 border-r border-slate-800 sidebar-closed lg:sidebar-open flex flex-col">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center">
            <span class="font-bold tracking-widest text-slate-400 text-xs uppercase">Navigation</span>
            <button onclick="App.toggleSidebar()" class="lg:hidden text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <nav class="flex-1 py-4">
            <button onclick="App.navigate('schedule')" id="nav-schedule" class="nav-link w-full text-left px-6 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Weekly Schedule
            </button>
            <button onclick="App.navigate('phases')" id="nav-phases" class="nav-link w-full text-left px-6 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                Phases
            </button>
            <button onclick="App.navigate('zones')" id="nav-zones" class="nav-link w-full text-left px-6 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v4l3 3"></path></svg>
                Zones
            </button>
            <button onclick="App.navigate('gear')" id="nav-gear" class="nav-link w-full text-left px-6 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                Gear Choice
            </button>
            <button onclick="App.navigate('full')" id="nav-full" class="nav-link w-full text-left px-6 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Full Plan
            </button>
        </nav>

        <div class="p-6 border-t border-slate-800">
            <div class="flex items-center space-x-2">
                <div id="sync-status-dot" class="w-2 h-2 rounded-full bg-slate-600"></div>
                <span id="sync-status-text" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">OFFLINE</span>
            </div>
        </div>
    </aside>

    <!-- TOP MOBILE BAR -->
    <header class="lg:hidden bg-slate-900 border-b border-slate-800 sticky top-0 z-40 h-16 flex items-center px-4">
        <button onclick="App.toggleSidebar()" class="p-2 text-slate-400 hover:text-white focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <h1 class="ml-4 text-lg font-bold text-white tracking-tight" id="mobile-header-title">Weekly Schedule</h1>
    </header>

    <div class="main-content">
        <header class="max-w-5xl mx-auto px-4 pt-12 pb-8 hidden lg:block">
            <h1 class="text-4xl font-extrabold text-white sm:text-5xl tracking-tight" id="header-title">Weekly Schedule</h1>
            <p class="mt-3 text-slate-400 text-lg">Synchronized Performance Suite</p>
        </header>

        <main class="max-w-5xl mx-auto px-4 pt-8 lg:pt-0 pb-20">
            <div id="stats-bar" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-10">
                <div class="bg-slate-800/50 border border-slate-700 p-4 rounded-lg">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Current Phase</p>
                    <p class="text-lg font-semibold text-blue-400" id="stat-phase">--</p>
                </div>
                <div class="bg-slate-800/50 border border-slate-700 p-4 rounded-lg">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Current Week</p>
                    <p class="text-lg font-semibold text-slate-300" id="stat-week">--</p>
                </div>
                <div class="bg-slate-800/50 border border-slate-700 p-4 rounded-lg">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Next Event</p>
                    <div id="stat-event">
                        <p class="text-lg font-semibold text-emerald-400 leading-tight" id="stat-event-name">--</p>
                        <p class="text-xs font-normal text-slate-400 mt-1" id="stat-event-countdown">--</p>
                    </div>
                </div>
            </div>

            <div id="loader" class="flex flex-col items-center py-20 hidden">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-white"></div>
            </div>

            <div id="content" class="markdown-body opacity-0 transition-opacity duration-500"></div>
        </main>
    </div>

    <script>
        const CONFIG = {
            PLAN_FILE: "endurance_plan.md",
            GEAR_FILE: "Gear.md",
            WKG_SCALE: { min: 1.0, max: 6.0 },
            CATEGORIES: [
                { threshold: 5.05, label: "Exceptional", color: "#a855f7" },
                { threshold: 3.93, label: "Very Good",   color: "#3b82f6" },
                { threshold: 2.79, label: "Good",        color: "#22c55e" },
                { threshold: 2.23, label: "Fair",        color: "#f97316" },
                { threshold: 0.00, label: "Untrained",   color: "#ef4444" }
            ]
        };

        const Parser = {
            getSection(md, title) {
                if (!md) return "";
                const lines = md.split('\n');
                let capturing = false, section = [];
                for (let line of lines) {
                    const trimmed = line.trim();
                    // Robust check: Only lines starting with # are true headers
                    // This prevents capturing bold text paragraphs as headers
                    const isHeader = trimmed.startsWith('#');
                    const lowTitle = title.toLowerCase();
                    const lowLine = trimmed.toLowerCase();
                    
                    if (isHeader && lowLine.includes(lowTitle)) { 
                        capturing = true; 
                        continue; 
                    }
                    if (capturing && isHeader) break;
                    if (capturing) section.push(line);
                }
                return section.join('\n').trim();
            },

            getBiometrics(md) {
                const profileSection = this.getSection(md, "Profile") || this.getSection(md, "Biometrics");
                const ftp = profileSection.match(/Cycling FTP[^0-9]*(\d{1,3})/i);
                const weight = profileSection.match(/Weight[^0-9]*(\d{1,3})/i);
                return {
                    watts: ftp ? parseInt(ftp[1]) : 0,
                    weight: weight ? parseInt(weight[1]) : 0
                };
            },

            parseGearMatrix(md) {
                const results = { bike: [], run: [] };
                ['Cycling', 'Running'].forEach(type => {
                    const section = this.getSection(md, type);
                    const rows = section.split('\n').filter(l => l.includes('|') && !l.includes('---') && !l.toLowerCase().includes('temp'));
                    
                    rows.forEach(row => {
                        const parts = row.split('|').map(p => p.trim()).filter(p => p);
                        if (parts.length >= 2) {
                            const rangeStr = parts[0];
                            let min = -999, max = 999;
                            
                            if (rangeStr.includes('<')) {
                                min = -999;
                                max = parseInt(rangeStr.replace('<', '').trim()) || 30;
                            } else if (rangeStr.includes('+')) {
                                min = parseInt(rangeStr.replace('+', '').trim()) || 70;
                                max = 999;
                            } else {
                                // Handles formats like "35-40", "35 - 40", "35–40"
                                const nums = rangeStr.split(/[-–]/).map(n => parseInt(n.trim()));
                                if (nums.length === 2) {
                                    [min, max] = nums;
                                } else if (nums.length === 1 && !isNaN(nums[0])) {
                                    [min, max] = [nums[0], nums[0]];
                                }
                            }
                            
                            results[type === 'Cycling' ? 'bike' : 'run'].push({ 
                                min, 
                                max, 
                                gear: parts.slice(1).join(' | ') 
                            });
                        }
                    });
                });
                return results;
            }
        };

        const App = {
            planMd: "",
            gearMd: "",
            gearData: null,
            
            async init() {
                try {
                    const [planRes, gearRes] = await Promise.all([
                        fetch(`./${CONFIG.PLAN_FILE}?t=${Date.now()}`),
                        fetch(`./${CONFIG.GEAR_FILE}?t=${Date.now()}`)
                    ]);
                    
                    this.planMd = planRes.ok ? await planRes.text() : "";
                    this.gearMd = gearRes.ok ? await gearRes.text() : "";
                    this.gearData = Parser.parseGearMatrix(this.gearMd);

                    this.updateStats();
                    this.navigate('schedule');
                    this.updateSyncStatus(planRes.ok && gearRes.ok);
                } catch (e) {
                    console.error("Init Error:", e);
                    this.updateSyncStatus(false);
                    document.getElementById('content').innerHTML = `<p class='text-red-400'>Error loading required files. Ensure endurance_plan.md and Gear.md are available in the same directory.</p>`;
                }
            },

            updateSyncStatus(isLive) {
                const dot = document.getElementById('sync-status-dot');
                const text = document.getElementById('sync-status-text');
                if (dot && text) {
                    dot.className = `w-2 h-2 rounded-full ${isLive ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`;
                    text.innerText = isLive ? "LIVE SYNC" : "OFFLINE";
                    text.className = `text-[10px] font-bold uppercase tracking-widest ${isLive ? 'text-green-400' : 'text-red-400'}`;
                }
            },

            updateStats() {
                const status = this.planMd.match(/\*\*Status:\*\*\s*(Phase[^-]*)\s*-\s*(Week.*)/i);
                document.getElementById('stat-phase').innerText = status ? status[1].trim() : "Plan Active";
                document.getElementById('stat-week').innerText = status ? status[2].trim() : "N/A";
                
                const eventSection = Parser.getSection(this.planMd, "Event Schedule");
                const eventLines = eventSection.split('\n').filter(l => l.includes('|') && !l.toLowerCase().includes('date') && !l.includes('---'));
                
                const nameEl = document.getElementById('stat-event-name');
                const countdownEl = document.getElementById('stat-event-countdown');

                if (eventLines.length > 0) {
                    const parts = eventLines[0].split('|').map(p => p.trim()).filter(p => p.length > 0);
                    if (parts.length >= 2) {
                        const eventDate = new Date(parts[0]);
                        nameEl.innerText = parts[1];
                        if (!isNaN(eventDate)) {
                            const today = new Date(); today.setHours(0,0,0,0);
                            const diff = Math.ceil((eventDate - today) / 86400000);
                            if (diff < 0) countdownEl.innerText = "Completed";
                            else if (diff === 0) countdownEl.innerText = "Event Today!";
                            else countdownEl.innerText = `${diff} days to go`;
                        } else countdownEl.innerText = "Date TBD";
                    }
                }
            },

            navigate(view) {
                const titles = { schedule: 'Weekly Schedule', phases: 'Phases', zones: 'Zones', gear: 'Gear Selection', full: 'Master Plan' };
                document.getElementById('header-title').innerText = titles[view];
                document.getElementById('mobile-header-title').innerText = titles[view];

                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.getElementById(`nav-${view}`).classList.add('active');
                
                const content = document.getElementById('content');
                content.classList.add('opacity-0');
                
                setTimeout(() => {
                    if (view === 'gear') this.renderGear();
                    else if (view === 'zones') this.renderZones();
                    else this.renderMarkdown(view);
                    content.classList.remove('opacity-0');
                    if (window.innerWidth < 1024) this.toggleSidebar();
                }, 200);
            },

            renderMarkdown(view) {
                const mdMap = {
                    schedule: Parser.getSection(this.planMd, "Weekly Schedule"),
                    phases: Parser.getSection(this.planMd, "Periodization"),
                    full: this.planMd
                };
                document.getElementById('content').innerHTML = marked.parse(mdMap[view] || "*Content not found.*");
            },

            renderGear() {
                let tempOptions = '<option value="25">&lt;30°F</option>';
                for(let i=30; i<=70; i++) tempOptions += `<option value="${i}" ${i === 50 ? 'selected' : ''}>${i}°F</option>`;
                tempOptions += '<option value="75">70°F+</option>';

                const html = `
                    <div class="bg-slate-800/30 border border-slate-800 rounded-xl p-8 mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                            <div class="flex flex-col gap-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Select Activity</label>
                                <select id="gear-activity" onchange="App.updateGearResult()" class="gear-select">
                                    <option value="bike">Cycling</option>
                                    <option value="run" selected>Running</option>
                                </select>
                            </div>
                            <div class="flex flex-col gap-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Select Temperature</label>
                                <select id="gear-temp" onchange="App.updateGearResult()" class="gear-select">
                                    ${tempOptions}
                                </select>
                            </div>
                        </div>

                        <!-- Stacked Layout: Standard above Windy & Rainy -->
                        <div class="flex flex-col gap-6">
                            <div class="p-6 bg-slate-900/80 rounded-lg border border-slate-700 flex flex-col shadow-lg">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                    <h4 class="text-xs font-bold text-slate-300 uppercase tracking-wider">Standard Conditions</h4>
                                </div>
                                <div id="gear-result-standard" class="text-slate-100 text-lg font-medium italic min-h-[3rem]">
                                    Calculating gear selection...
                                </div>
                            </div>

                            <div class="p-6 bg-slate-900/80 rounded-lg border border-slate-700 flex flex-col shadow-lg">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                                    <h4 class="text-xs font-bold text-slate-300 uppercase tracking-wider">Windy & Rainy</h4>
                                </div>
                                <div id="gear-result-weather" class="text-slate-100 text-lg font-medium italic min-h-[3rem]">
                                    Adjusting for weather...
                                </div>
                                <p class="text-[10px] text-slate-500 mt-4 italic font-semibold border-t border-slate-800 pt-3">
                                    Note: Automatically selects gear for -10°F perceived temp adjustment.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 border-t border-slate-800 pt-8">
                        <div class="flex items-center gap-2 mb-6">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest">Full Matrix Documentation</h3>
                        </div>
                        <div class="markdown-body">
                            ${marked.parse(this.gearMd || "*No gear data found in Gear.md.*")}
                        </div>
                    </div>
                `;
                document.getElementById('content').innerHTML = html;
                this.updateGearResult();
            },

            updateGearResult() {
                if (!this.gearData) {
                    console.warn("No gear data available to update results.");
                    return;
                }
                
                const activitySelect = document.getElementById('gear-activity');
                const tempSelect = document.getElementById('gear-temp');
                
                if (!activitySelect || !tempSelect) return;

                const activity = activitySelect.value;
                const temp = parseInt(tempSelect.value);
                
                const findMatch = (t) => {
                    const list = this.gearData[activity] || [];
                    
                    // Simple range matcher
                    const match = list.find(r => t >= r.min && t <= r.max);
                    if (match) return match.gear;
                    
                    // Boundary fallbacks
                    if (t < 30) {
                        const coldMatch = list.find(r => r.min === -999);
                        return coldMatch ? coldMatch.gear : "No extremely cold weather data available.";
                    }
                    if (t >= 70) {
                        const hotMatch = list.find(r => r.max === 999);
                        return hotMatch ? hotMatch.gear : "No hot weather gear data available.";
                    }
                    
                    return "No matching gear range found in documentation.";
                };

                const standardGear = findMatch(temp);
                const weatherGear = findMatch(temp - 10);

                document.getElementById('gear-result-standard').innerText = standardGear;
                document.getElementById('gear-result-weather').innerText = weatherGear;
            },

            renderZones() {
                const { watts, weight } = Parser.getBiometrics(this.planMd);
                const weightKg = weight * 0.453592;
                const wkgNum = weightKg > 0 ? (watts / weightKg) : 0;
                const cat = CONFIG.CATEGORIES.find(c => wkgNum >= c.threshold) || CONFIG.CATEGORIES[CONFIG.CATEGORIES.length - 1];
                const percent = Math.min(Math.max((wkgNum - CONFIG.WKG_SCALE.min) / (CONFIG.WKG_SCALE.max - CONFIG.WKG_SCALE.min), 0), 1);

                const html = `
                    <div class="gauge-wrapper">
                        <svg viewBox="0 0 300 185" class="gauge-svg">
                            <path d="M 30 150 A 120 120 0 0 1 64.1 66.2" fill="none" stroke="#ef4444" stroke-width="24" />
                            <path d="M 64.1 66.2 A 120 120 0 0 1 98.3 41.8" fill="none" stroke="#f97316" stroke-width="24" />
                            <path d="M 98.3 41.8 A 120 120 0 0 1 182.0 34.4" fill="none" stroke="#22c55e" stroke-width="24" />
                            <path d="M 182.0 34.4 A 120 120 0 0 1 249.2 82.6" fill="none" stroke="#3b82f6" stroke-width="24" />
                            <path d="M 249.2 82.6 A 120 120 0 0 1 270 150" fill="none" stroke="#a855f7" stroke-width="24" />
                            <text x="150" y="135" text-anchor="middle" class="text-4xl font-black fill-white">${wkgNum.toFixed(2)}</text>
                            <text x="150" y="160" text-anchor="middle" font-weight="800" fill="${cat.color}">${cat.label.toUpperCase()}</text>
                            <g class="gauge-needle" style="transform: rotate(${-90 + (percent * 180)}deg)">
                                <path d="M 147 150 L 150 45 L 153 150 Z" fill="white" />
                                <circle cx="150" cy="150" r="6" fill="white" />
                            </g>
                        </svg>
                    </div>
                    <div id="zone-grid">${this.parseZoneTables()}</div>
                `;
                document.getElementById('content').innerHTML = html;
            },

            parseZoneTables() {
                const section = Parser.getSection(this.planMd, "Training Parameters") || Parser.getSection(this.planMd, "Zones");
                let current = '', html = '', categories = {};
                section.split('\n').forEach(line => {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('###')) {
                        current = trimmed.replace(/###/g, '').split('(')[0].trim();
                        categories[current] = [];
                    } else if (current && trimmed.includes(':')) {
                        const [label, range] = trimmed.replace(/[\*\-\+]/g, '').split(':');
                        const zMatch = label.toLowerCase().match(/zone (\d)/);
                        const zNum = zMatch ? zMatch[1] : '1';
                        categories[current].push(`<div class="zone-row z-${zNum}"><span class="font-bold">${label.trim()}</span><span class="font-mono text-slate-400">${range ? range.trim() : '--'}</span></div>`);
                    }
                });
                
                const keys = Object.keys(categories);
                if (keys.length === 0) return `<p class="text-slate-500 text-center col-span-2">No zone data found in training plan.</p>`;
                
                keys.forEach(k => html += `<div class="zone-card"><div class="zone-card-title">${k}</div>${categories[k].join('')}</div>`);
                return html;
            },

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                sidebar.classList.toggle('sidebar-closed');
                sidebar.classList.toggle('sidebar-open');
                overlay.classList.toggle('hidden');
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
